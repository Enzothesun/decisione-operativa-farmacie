<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Decisione Operativa ‚Äì Farmacie Medigas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        font-family: 'Segoe UI', Arial, sans-serif;
        background: #f2f4f7;
        margin: 0;
        padding: 0;
    }

    header {
        background: #1e4e79;
        color: white;
        padding: 20px;
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    .banner {
        background: #1e4e79;
        color: #ffffff;
        padding: 16px 20px;
        margin: 20px;
        border-radius: 12px;
        font-size: 15px;
        line-height: 1.5;
        box-shadow: 0 3px 8px rgba(0,0,0,0.18);
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 10px 20px 40px;
    }

    .section {
        background: white;
        padding: 22px;
        border-radius: 14px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        margin-bottom: 20px;
    }

    .section h2 {
        margin-top: 0;
        color: #1e4e79;
        font-size: 20px;
        font-weight: 700;
    }

    label {
        font-weight: 600;
        display: block;
        margin-top: 10px;
        font-size: 15px;
    }

    select, input {
        width: 100%;
        padding: 12px;
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid #b3b3b3;
        background: #fafafa;
        font-size: 15px;
    }

    button {
        width: 100%;
        padding: 14px;
        margin-top: 20px;
        background: #1e4e79;
        color: white;
        border: none;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    button:hover {
        background: #163d61;
    }

    .output {
        background: white;
        padding: 25px;
        border-left: 6px solid #1e4e79;
        border-radius: 12px;
        font-size: 16px;
        line-height: 1.6;
        box-shadow: 0 3px 10px rgba(0,0,0,0.12);
    }
</style>
</head>

<body>

<header>Decisione Operativa ‚Äì Farmacie Medigas</header>

<div class="banner">
    <b>Procedura Medigas</b><br>
    Tutte le farmacie BS, TO, Emilia e Sud Sardegna devono sempre inserire la richiesta sul Portale.<br>
    <b>Uffici aperti:</b> invita all‚Äôinserimento (non si gestisce telefonicamente) + Generica Brescia.<br>
    <b>Uffici chiusi:</b> in urgenza gestisci la consegna + invita all‚Äôinserimento + Generica Brescia.
</div>

<div class="container">

    <div class="section">
        <h2>Dati richiesta farmacia</h2>

        <label>Area farmacia</label>
        <select id="area" onchange="popolaSottozone()">
            <option value="">‚Äî Seleziona ‚Äî</option>
            <option value="brescia">Brescia e provincia</option>
            <option value="torino">Comuni di Torino</option>
            <option value="emilia">Emilia Romagna</option>
            <option value="sardegna">Sud Sardegna</option>
            <option value="resto">Resto d‚ÄôItalia</option>
        </select>

        <label>Zona / territorio</label>
        <select id="zona">
            <option value="">‚Äî Seleziona l'area prima ‚Äî</option>
        </select>

        <label>Giorno richiesto</label>
        <input type="date" id="dataRichiesta">

        <label>Data e ora inserimento su Portale</label>
        <input type="datetime-local" id="dataInserimento">

        <button onclick="calcola()">Genera Decisione</button>
    </div>

    <div class="section">
        <h2>Risultato</h2>
        <div id="result" class="output">In attesa dei dati‚Ä¶</div>
    </div>

</div>

<script>
/* ================================
   SOTTOZONE PER AREA
================================ */
const sottozoneByArea = {
    brescia: ["Franciacorta","Lago d'Iseo","Brescia citt√†","Bassa Bresciana","Valsabbia","Vallecamonica","Lago di Garda","Valtrompia"],
    emilia: ["Cesena","Forl√¨","Ravenna","Faenza","Lugo"],
    torino: ["Comuni di Torino"],
    sardegna: ["Sud Sardegna"]
};

function popolaSottozone() {
    const area = document.getElementById("area").value;
    const zonaSel = document.getElementById("zona");
    zonaSel.innerHTML = "";

    if (!area || area === "resto") {
        zonaSel.disabled = true;
        zonaSel.innerHTML = `<option value="">${
            area === "resto" ? "Nessuna sottozona necessaria" : "‚Äî Seleziona l'area prima ‚Äî"
        }</option>`;
        return;
    }

    zonaSel.disabled = false;
    zonaSel.innerHTML = `<option value="">‚Äî Seleziona zona ‚Äî</option>`;
    sottozoneByArea[area].forEach(z => zonaSel.innerHTML += `<option value="${z}">${z}</option>`);
}

/* ================================
   COSTI SUPPLEMENTO
================================ */
const costi = {
    brescia: "25 ‚Ç¨",
    emilia: "50 ‚Ç¨",
    torino: "50 ‚Ç¨",
    sardegna: "‚Äî",
    resto: "0 ‚Ç¨"
};

/* ================================
   UTILS
================================ */
function isWorkingDay(d){return d.getDay()>=1 && d.getDay()<=5;}
function addDays(d,n){return new Date(d.getTime()+n*86400000);}
function addWorkingDays(start,n){
    let d=new Date(start), added=0;
    while(added<n){d=addDays(d,1);if(isWorkingDay(d)) added++;} return d;
}
function formatDate(d){
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

/* ================================
   LOGICA PIANI BS / TO / EMILIA / SARDEGNA
================================ */
function isInPiano(area,zona,day){
    const map={
        brescia:{
            lunedi:["Franciacorta","Lago d'Iseo","Brescia citt√†","Bassa Bresciana","Valsabbia"],
            martedi:["Vallecamonica","Lago di Garda","Brescia citt√†","Valtrompia"],
            mercoledi:["Franciacorta","Lago d'Iseo","Brescia citt√†","Bassa Bresciana","Valsabbia"],
            giovedi:["Vallecamonica","Lago di Garda","Brescia citt√†","Valtrompia"],
            venerdi:["Franciacorta","Lago d'Iseo","Brescia citt√†","Bassa Bresciana","Valsabbia"]
        },
        emilia:{
            lunedi:["Cesena","Ravenna","Faenza","Lugo"],
            martedi:["Forl√¨","Ravenna","Faenza","Lugo"],
            mercoledi:["Cesena","Ravenna","Faenza","Lugo"],
            giovedi:["Forl√¨","Ravenna","Faenza","Lugo"],
            venerdi:["Cesena","Ravenna","Faenza","Lugo"]
        },
        torino:{
            lunedi:["Comuni di Torino"], martedi:["Comuni di Torino"], mercoledi:["Comuni di Torino"],
            giovedi:["Comuni di Torino"], venerdi:["Comuni di Torino"]
        },
        sardegna:{
            lunedi:["Sud Sardegna"],
            giovedi:["Sud Sardegna"],
            venerdi:["Sud Sardegna"]
        }
    };
    return map[area]?.[day]?.includes(zona) ?? false;
}

/* ================================
   CALCOLO GIORNO GARANTITO
================================ */
function computeGuaranteedDate(area,zona,dtIns){
    const giorni=["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];
    const d0=new Date(dtIns.getFullYear(),dtIns.getMonth(),dtIns.getDate());
    const day=d0.getDay();

    let baseDate, offset;
    if(day===6||day===0){
        baseDate=addDays(d0, day===6?2:1);
        offset=1;
    } else {
        const h=dtIns.getHours(), m=dtIns.getMinutes();
        const entro=(h<13 || (h===13 && m===0));
        offset=entro?1:2;
        baseDate=d0;
    }

    let garantito=addWorkingDays(baseDate,offset);

    while(true){
        const name=giorni[garantito.getDay()];
        if(isWorkingDay(garantito) && isInPiano(area,zona,name)) break;
        garantito=addWorkingDays(garantito,1);
    }

    return garantito;
}

/* ================================
   FUNZIONE PRINCIPALE
================================ */
function calcola(){
    const area=document.getElementById("area").value;
    const zona=document.getElementById("zona").value;
    const dRich=document.getElementById("dataRichiesta").value;
    const dIns=document.getElementById("dataInserimento").value;
    const out=document.getElementById("result");

    if(!area || !dRich || !dIns || (area!=="resto" && !zona)){
        out.innerHTML="‚ö†Ô∏è Compila tutti i campi.";
        return;
    }

    const dtRich=new Date(dRich);
    const dtIns=new Date(dIns);
    const giorni=["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];
    const giornoRich=giorni[dtRich.getDay()];

    /* ============================================================
       üîµ SELEZIONE RESTO D‚ÄôITALIA ‚Üí MOSTRA PROCEDURA COMPLETA
    ============================================================ */
    if(area==="resto"){
        out.innerHTML = `
<b>RESTO D‚ÄôITALIA ‚Äì Procedura completa</b><br><br>

<b>Nuove Attivazioni</b><br>
La farmacia pu√≤ richiedere una nuova attivazione.<br>
L‚Äôoperatore deve verificare la copertura nell‚Äôallegato Medigas su SharePoint.<br><br>

<b>Zone dove Medigas effettua nuove attivazioni O‚ÇÇ gassoso</b><br>
<b>Lombardia</b><br>
‚Ä¢ Varese e provincia<br>
‚Ä¢ Como e provincia<br>
‚Ä¢ Lecco e provincia<br>
‚Ä¢ Monza Brianza e provincia<br>
‚Ä¢ Farmacia di Aprica (SO)<br><br>

<b>Lazio</b><br>
‚Ä¢ Roma e provincia<br><br>

<b>Veneto</b><br>
‚Ä¢ Tutta la regione<br><br>

<b>Se NON coperta:</b> ‚ÄúMedigas in questa zona continua a servire solo i pazienti gi√† attivi e non effettua nuove attivazioni.‚Äù<br><br>

<b>NB ‚Äì Nuova attivazione dopo le 17:00 con consegna per il giorno successivo:</b><br>
L‚Äôoperatore deve avvisare telefonicamente il vettore che Assago potrebbe inserire la consegna nel piano del giorno seguente.<br><br>

<hr>

<b>Consegne Ordinarie (paziente gi√† attivo)</b><br>
Le consegne seguono la procedura generale Medigas.<br>
Lo strumento non calcola giorni di piano n√© supplementi per il Resto d‚ÄôItalia.<br><br>

<b>Riepilogo:</b><br>
‚Ä¢ Nuove attivazioni ‚Üí verifica copertura + eventuale nota 17:00<br>
‚Ä¢ Zone non coperte ‚Üí NO nuove attivazioni<br>
‚Ä¢ Pazienti gi√† attivi ‚Üí consegna ordinaria conforme a procedura Medigas<br>
`;
        return;
    }

    /* ============================================================
       üîµ AREE CALCOLATE (BS / TO / EMILIA / SUD SARDEGNA)
    ============================================================ */

    const inPiano=isInPiano(area,zona, giornoRich);
    const dtGarantito=computeGuaranteedDate(area,zona,dtIns);
    const giornoGarantito=giorni[dtGarantito.getDay()];

    const reqDay=new Date(dtRich.getFullYear(),dtRich.getMonth(),dtRich.getDate());
    const garDay=new Date(dtGarantito.getFullYear(),dtGarantito.getMonth(),dtGarantito.getDate());

    let supplemento="NO";
    let motivo="La richiesta rispetta il cut-off e il piano consegne.";

    if(!inPiano){
        supplemento="SI";
        motivo="Giorno richiesto non previsto dal piano consegne.";
    }
    else if(reqDay < garDay){
        supplemento="SI";
        motivo="Richiesta precedente al giorno garantito dal cut-off.";
    }

    out.innerHTML=
`üìç <b>Area:</b> ${area.toUpperCase()}<br>
<b>Zona:</b> ${zona}<br><br>

<b>Giorno richiesto:</b> ${giornoRich.toUpperCase()} (${formatDate(reqDay)})<br>
<b>Giorno garantito (cut-off + piano):</b> ${giornoGarantito.toUpperCase()} (${formatDate(garDay)})<br><br>

<b>Piano consegne:</b> ${inPiano ? "‚úî In piano" : "‚õî Fuori piano"}<br>
<b>Supplemento:</b> ${supplemento} (importo zona: ${costi[area]})<br>
<b>Motivo:</b> ${motivo}`;
}
</script>

</body>
</html>
