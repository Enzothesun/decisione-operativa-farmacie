<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Decisione Operativa ‚Äì Farmacie Medigas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f2f4f7; margin: 0; padding: 0; }
    header { background: #1e4e79; color: white; padding: 24px; text-align: center; font-size: 24px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
    .section { background: white; padding: 22px; border-radius: 14px; margin-bottom: 25px; box-shadow: 0 3px 10px rgba(0,0,0,0.12); }
    .section h2 { margin-top: 0; color: #1e4e79; font-size: 20px; font-weight: 600; border-left: 6px solid #1e4e79; padding-left: 10px; }
    label { font-weight: 600; display: block; margin-top: 14px; font-size: 15px; }
    select, input { width: 100%; padding: 12px; margin-top: 6px; border-radius: 8px; border: 1px solid #b3b3b3; background: #fafafa; font-size: 15px; }
    button { width: 100%; padding: 15px; margin-top: 25px; background: #1e4e79; color: white; border: none; font-size: 18px; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
    button:hover { background: #163d61; }
    .output { background: #ffffff; padding: 25px; margin-top: 15px; border-left: 6px solid #1e4e79; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.12); font-size: 16px; line-height: 1.6; }
    .output-title { font-size: 20px; font-weight: 600; color: #1e4e79; margin-bottom: 12px; }
    .highlight-red { color: #c62828; font-weight: 600; }
    .highlight-green { color: #2e7d32; font-weight: 600; }
</style>
</head>
<body>

<header>üíä Decisione Operativa ‚Äì Farmacie Medigas</header>

<div class="container">
    <div class="section">
        <h2>Input</h2>

        <label>Area farmacia</label>
        <select id="area" onchange="popolaSottozone()">
            <option value="">‚Äî Seleziona ‚Äî</option>
            <option value="brescia">Brescia e provincia</option>
            <option value="torino">Comuni di Torino</option>
            <option value="emilia">Emilia Romagna</option>
            <option value="sardegna">Sud Sardegna</option>
            <option value="resto">Resto d‚ÄôItalia</option>
        </select>

        <label>Zona / territorio</label>
        <select id="zona">
            <option value="">‚Äî Seleziona l'area prima ‚Äî</option>
        </select>

        <label>Giorno richiesto dalla farmacia</label>
        <input type="date" id="dataRichiesta">

        <label>Data e ora inserimento su Infomed</label>
        <input type="datetime-local" id="dataInserimento">

        <button onclick="calcola()">Genera Decisione Operativa</button>
    </div>

    <div class="section">
        <h2>Risultato</h2>
        <div id="result" class="output">Compila i campi per generare la decisione operativa.</div>
    </div>
</div>

<script>
// ---- Orari apertura/chiusura uffici (solo per parte procedurale) ----
function isUfficioAperto(dt) {
    const g = dt.getDay(), h = dt.getHours(), m = dt.getMinutes();
    if (g >= 1 && g <= 4)
        return (h > 8 && h < 17) || (h === 8 && m >= 0) || (h === 17 && m === 0);
    if (g === 5)
        return (h > 8 && h < 16) || (h === 8 && m >= 0) || (h === 16 && m === 0);
    return false;
}

// ---- Sottozone disponibili per area ----
const sottozoneByArea = {
    brescia: [
        "Franciacorta",
        "Lago d'Iseo",
        "Brescia citt√†",
        "Bassa Bresciana",
        "Valsabbia",
        "Vallecamonica",
        "Lago di Garda",
        "Valtrompia"
    ],
    emilia: [
        "Cesena",
        "Forl√¨",
        "Ravenna",
        "Faenza",
        "Lugo"
    ],
    torino: [
        "Comuni di Torino"
    ],
    sardegna: [
        "Sud Sardegna"
    ]
};

function popolaSottozone() {
    const area = document.getElementById("area").value;
    const zonaSel = document.getElementById("zona");
    zonaSel.innerHTML = "";

    if (!area || area === "resto") {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = area === "resto"
            ? "Per il Resto d'Italia non serve selezionare la zona"
            : "‚Äî Seleziona l'area prima ‚Äî";
        zonaSel.appendChild(opt);
        zonaSel.disabled = (area === "resto" || !area);
        return;
    }

    zonaSel.disabled = false;
    const first = document.createElement("option");
    first.value = "";
    first.textContent = "‚Äî Seleziona zona ‚Äî";
    zonaSel.appendChild(first);

    sottozoneByArea[area].forEach(z => {
        const opt = document.createElement("option");
        opt.value = z;
        opt.textContent = z;
        zonaSel.appendChild(opt);
    });
}

// ---- Costi per area ----
const costi = {
    brescia:"25 ‚Ç¨",
    emilia:"50 ‚Ç¨",
    torino:"50 ‚Ç¨",
    sardegna:"‚Äî (non disponibili)",
    resto:"0 ‚Ç¨"
};

// ---- Giorni lavorativi (lun‚Äìven) ----
function isWorkingDay(d) {
    const g = d.getDay();
    return g >= 1 && g <= 5; // lun=1 ‚Ä¶ ven=5
}

function addDays(d, n) {
    return new Date(d.getTime() + n*24*60*60*1000);
}

// aggiunge N giorni lavorativi (salta sab e dom)
function addWorkingDays(startDate, n) {
    let d = new Date(startDate.getTime());
    let added = 0;
    while (added < n) {
        d = addDays(d, 1);
        if (isWorkingDay(d)) added++;
    }
    return d;
}

// ---- Piano consegne preciso per area/zona/giorno ----
function isInPiano(area, zona, giorno) {
    // giorno: "lunedi" ... "venerdi"
    if (area === "brescia") {
        if (giorno === "lunedi" || giorno === "mercoledi" || giorno === "venerdi") {
            return ["Franciacorta","Lago d'Iseo","Brescia citt√†","Bassa Bresciana","Valsabbia"]
                .includes(zona);
        }
        if (giorno === "martedi" || giorno === "giovedi") {
            return ["Vallecamonica","Lago di Garda","Brescia citt√†","Valtrompia"]
                .includes(zona);
        }
        return false;
    }

    if (area === "emilia") {
        if (giorno === "lunedi" || giorno === "mercoledi" || giorno === "venerdi") {
            return ["Cesena","Ravenna","Faenza","Lugo"].includes(zona);
        }
        if (giorno === "martedi" || giorno === "giovedi") {
            return ["Forl√¨","Ravenna","Faenza","Lugo"].includes(zona);
        }
        return false;
    }

    if (area === "torino") {
        // Comuni di Torino in piano lun‚Äìven
        return ["lunedi","martedi","mercoledi","giovedi","venerdi"].includes(giorno);
    }

    if (area === "sardegna") {
        // Sud Sardegna lun, gio, ven
        if (zona !== "Sud Sardegna") return false;
        return ["lunedi","giovedi","venerdi"].includes(giorno);
    }

    return false;
}

// ---- Calcolo giorno garantito (cut-off + piano) ----
function computeGuaranteedDate(area, zona, dtIns) {
    const onlyDate = new Date(dtIns.getFullYear(), dtIns.getMonth(), dtIns.getDate());
    let wd = onlyDate.getDay();
    let baseDate;
    let offset;

    // sabato (6) o domenica (0) ‚Üí come luned√¨ dopo le 13 ‚Üí +2 giorni lavorativi
    if (wd === 6 || wd === 0) {
        // spostiamo al luned√¨ successivo
        const daysToMon = (wd === 6) ? 2 : 1; // sab‚Üí+2, dom‚Üí+1
        baseDate = addDays(onlyDate, daysToMon);
        offset = 2;
    } else {
        // lun‚Äìven ‚Üí vediamo orario cut-off 13:00
        baseDate = onlyDate;
        const h = dtIns.getHours();
        const m = dtIns.getMinutes();
        const entroCutoff = (h < 13) || (h === 13 && m === 0);
        offset = entroCutoff ? 1 : 2;
    }

    // primo giorno garantito "tecnico" (solo su base giorni lavorativi)
    let guaranteed = addWorkingDays(baseDate, offset);

    // lo adeguiamo al piano consegne reale (spostandoci in avanti finch√© non troviamo un giorno in piano)
    const giorni = ["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];
    while (true) {
        const gName = giorni[guaranteed.getDay()];
        if (isWorkingDay(guaranteed) && isInPiano(area, zona, gName)) break;
        guaranteed = addWorkingDays(guaranteed, 1);
    }

    return guaranteed;
}

// ---- Utility formato data DD/MM/YYYY ----
function formatDate(d) {
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

// ---- Funzione principale ----
function calcola() {
    const area = document.getElementById("area").value;
    const zona = document.getElementById("zona").value;
    const dRich = document.getElementById("dataRichiesta").value;
    const dIns = document.getElementById("dataInserimento").value;
    const res = document.getElementById("result");

    if (!area || !dRich || !dIns || (area !== "resto" && !zona)) {
        res.innerHTML = "<span class='highlight-red'>‚ö†Ô∏è Compila tutti i campi (inclusa la zona se richiesta).</span>";
        return;
    }

    const dtRich = new Date(dRich);
    const dtIns = new Date(dIns);
    const giorni = ["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];
    const giornoRich = giorni[dtRich.getDay()];
    const apertura = isUfficioAperto(dtIns);

    // Resto d'Italia ‚Üí logica separata
    if (area === "resto") {
        res.innerHTML = `
            <div class="output-title">üìç Area: Resto d‚ÄôItalia</div>
            ‚úî La farmacia pu√≤ fare richiesta telefonica<br>
            ‚úî Nessun obbligo di inserimento su Infomed<br>
            ‚úî Costi supplementari: 0 ‚Ç¨<br><br>
            <b>Procedura:</b><br>
            ‚Äì Accogliere la richiesta telefonicamente<br>
            ‚Äì Fine
        `;
        return;
    }

    const inPianoRichiesto = isInPiano(area, zona, giornoRich);
    const guaranteed = computeGuaranteedDate(area, zona, dtIns);
    const giornoGarantitoNome = giorni[guaranteed.getDay()];
    const costo = costi[area];

    // Confronto richiesto vs garantito (solo data)
    const reqDateOnly = new Date(dtRich.getFullYear(), dtRich.getMonth(), dtRich.getDate());
    const guarDateOnly = new Date(guaranteed.getFullYear(), guaranteed.getMonth(), guaranteed.getDate());

    let supplemento = "NO";
    let motivoSupp = "La data richiesta √® uguale o successiva al giorno garantito dal cut-off.";

    if (reqDateOnly.getTime() < guarDateOnly.getTime()) {
        supplemento = "SI";
        motivoSupp = "La farmacia richiede una consegna in data precedente rispetto al giorno garantito dal cut-off.";
    }

    let html = `
        <div class="output-title">üìç Area: ${area.toUpperCase()}</div>
        <b>Zona:</b> ${zona}<br>
        <b>Giorno richiesto:</b> ${giornoRich.toUpperCase()} (${formatDate(reqDateOnly)})<br>
        <b>Inserimento ordine:</b> ${apertura ? "<span class='highlight-green'>Uffici APERTI</span>" : "<span class='highlight-red'>Uffici CHIUSI</span>"}<br>
        <b>Giorno garantito (cut-off + piano):</b> ${giornoGarantitoNome.toUpperCase()} (${formatDate(guaranteed)})<br>
        <b>Piano consegne (giorno richiesto):</b> ${inPianoRichiesto ? "‚úî In piano" : "‚õî Fuori piano"}<br>
        <b>Supplemento:</b> ${supplemento} (importo zona: ${costo})<br>
        <small>${motivoSupp}</small><br><br>
        <div class="output-title">üîπ Procedura Operativa</div>
    `;

    if (apertura) {
        html += `
            ‚Äì NON prendere in carico la richiesta<br>
            ‚Äì NON inserire nulla su Infomed<br>
            ‚Äì Invitare la farmacia a inserire su Infomed<br>
            ‚Äì Aprire <b>Generica Brescia ‚Äì per tutte le zone</b><br>
            ‚Äì Gestione passa ad Assago
        `;
    } else {
        html += `
            <u>Se richiesta per giorni successivi:</u><br>
            ‚Äì Invitare la farmacia a usare Infomed<br>
            ‚Äì Aprire <b>Generica Brescia</b><br><br>
            <u>Se URGENZA (sera/festivi):</u><br>
            ‚Äì L‚Äôoperatore pu√≤ prendere in carico<br>
            ‚Äì Comunicare eventuali costi<br>
            ‚Äì Contattare il trasportatore<br>
            ‚Äì Aprire <b>Generica Brescia</b>
        `;
    }

    res.innerHTML = html;
}
</script>

</body>
</html>
