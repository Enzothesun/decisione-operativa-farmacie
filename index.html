<script>
/* ==========================================================
   DINAMICA MOSTRA/NASCONDI INPUT PER RESTO D’ITALIA
========================================================== */
function gestisciSezione() {
    const area = document.getElementById("area").value;
    const inputs = document.getElementById("container-inputs");
    const out = document.getElementById("result");

    if (area === "resto") {
        inputs.style.display = "none";  // nasconde i campi
        mostraProceduraResto();         // mostra subito procedura
    } else {
        inputs.style.display = "block"; // mostra i campi
        out.innerHTML = "Compila i campi per generare la decisione operativa.";
    }
}

/* ==========================================================
   PROCEDURA COMPLETA RESTO D’ITALIA (MOSTRATA SUBITO)
========================================================== */
function mostraProceduraResto() {
    document.getElementById("result").innerHTML = `
<b>RESTO D’ITALIA – Procedura Operativa</b><br><br>

<div class="col-container">

    <div class="col">
        <h3>Nuova Attivazione O₂ gassoso</h3>
        La farmacia può sempre richiedere una nuova attivazione.<br><br>

        <b>Zone abilitate</b>
        <ul>
            <li><b>Lombardia</b>: Varese, Como, Lecco, Monza Brianza, Aprica (SO)</li>
            <li><b>Lazio</b>: Roma e provincia</li>
            <li><b>Veneto</b>: tutta la regione</li>
        </ul>

        <b>Se non coperta</b><br>
        “Medigas in questa zona non effettua nuove attivazioni.”<br><br>

        <b>Consegna per i giorni successivi</b>
        <ul>
            <li>Inserire su Infomed</li>
            <li>Assago richiama la farmacia</li>
        </ul>

        <b>Consegna in giornata</b>
        <ul>
            <li>Non garantita</li>
            <li>Dire che Assago richiamerà</li>
            <li>Avvisare comunque il vettore</li>
        </ul>

        <b>Orari critici</b>
        <ul>
            <li>Dopo le 17 (lun–gio): giorno successivo → chiamare vettore</li>
            <li>Dopo le 17 in giornata → autorizzazione commerciale</li>
            <li>Venerdì prima 16: consegna venerdì</li>
            <li>Venerdì 16–19: autorizzazione + consegna venerdì</li>
            <li>Venerdì dopo 19: autorizzazione + possibile sabato</li>
            <li>Sab/Dom: sempre autorizzazione commerciale</li>
        </ul>
    </div>

    <div class="col">
        <h3>Consegna Ordinaria</h3>

        La farmacia può richiedere la consegna in <b>qualsiasi giorno e orario</b>.<br>
        La fornitura non si nega mai.<br><br>

        <b>Quando chiamare il vettore</b>
        <ul>
            <li>Consegna in giornata</li>
            <li>Richiesta per sabato/domenica</li>
        </ul>

        <b>Regole sabato/domenica</b>
        <ul>
            <li>Non si programmano consegne per sab/dom</li>
            <li>Giovedì → consegna venerdì</li>
            <li>Venerdì &lt; 19 → consegna venerdì</li>
            <li>Venerdì &gt; 19 → possibile sabato</li>
        </ul>

        <b>Se la richiesta arriva sabato o domenica</b>
        <ul>
            <li>OLT emergenza</li>
            <li>Vettore reperibile</li>
            <li>Infomed emergenza</li>
        </ul>

        <b>Riepilogo rapido</b>
        <ul>
            <li>In giornata → chiamare vettore</li>
            <li>Sab/Dom → reperibile</li>
            <li>Ven &lt; 19 → venerdì</li>
            <li>Ven &gt; 19 → sabato</li>
        </ul>
    </div>

</div>
`;
}

/* ==========================================================
   SOTTOZONE + COSTI
========================================================== */
const sottozoneByArea = {
    brescia: ["Franciacorta","Lago d'Iseo","Brescia città","Bassa Bresciana","Valsabbia","Vallecamonica","Lago di Garda","Valtrompia"],
    emilia: ["Cesena","Forlì","Ravenna","Faenza","Lugo"]
};

function popolaSottozone() {
    const area = document.getElementById("area").value;
    const zona = document.getElementById("zona");

    zona.innerHTML = "";

    if (!area) {
        zona.disabled = true;
        zona.innerHTML = `<option>— Seleziona l'area prima —</option>`;
        return;
    }

    if (area === "torino" || area === "sardegna" || area === "resto") {
        zona.disabled = true;
        zona.innerHTML = `<option>Nessuna sottozona richiesta</option>`;
        return;
    }

    zona.disabled = false;
    zona.innerHTML = `<option>— Seleziona sottozona —</option>`;
    sottozoneByArea[area].forEach(z => zona.innerHTML += `<option>${z}</option>`);
}

const costi = {
    brescia: "25 €",
    emilia: "50 €",
    torino: "50 €",
    sardegna: "—",
    resto: "0 €"
};

/* ==========================================================
   UTILITY DATE
========================================================== */
function isWorkingDay(d){ const wd=d.getDay(); return wd>=1&&wd<=5; }
function addDays(d,n){return new Date(d.getTime()+n*86400000);}
function addWorkingDays(start,n){
    let d=new Date(start),added=0;
    while(added<n){ d=addDays(d,1); if(isWorkingDay(d)) added++; }
    return d;
}
function formatDate(d){
    return `${String(d.getDate()).padStart(2,"0")}/${String(d.getMonth()+1).padStart(2,"0")}/${d.getFullYear()}`;
}

/* ==========================================================
   PIANI CONSEGNE
========================================================== */
function isInPiano(area,zona,day){
    const map={
        brescia:{
            lunedi:["Franciacorta","Lago d'Iseo","Brescia città","Bassa Bresciana","Valsabbia"],
            martedi:["Vallecamonica","Lago di Garda","Brescia città","Valtrompia"],
            mercoledi:["Franciacorta","Lago d'Iseo","Brescia città","Bassa Bresciana","Valsabbia"],
            giovedi:["Vallecamonica","Lago di Garda","Brescia città","Valtrompia"],
            venerdi:["Franciacorta","Lago d'Iseo","Brescia città","Bassa Bresciana","Valsabbia"]
        },
        emilia:{
            lunedi:["Cesena","Ravenna","Faenza","Lugo"],
            martedi:["Forlì","Ravenna","Faenza","Lugo"],
            mercoledi:["Cesena","Ravenna","Faenza","Lugo"],
            giovedi:["Forlì","Ravenna","Faenza","Lugo"],
            venerdi:["Cesena","Ravenna","Faenza","Lugo"]
        },
        torino:{ lunedi:["Comuni di Torino"], martedi:["Comuni di Torino"], mercoledi:["Comuni di Torino"], giovedi:["Comuni di Torino"], venerdi:["Comuni di Torino"] },
        sardegna:{ lunedi:["Sud Sardegna"], giovedi:["Sud Sardegna"], venerdi:["Sud Sardegna"] }
    };
    return (map[area]?.[day]||[]).includes(zona);
}

/* ==========================================================
   NUOVO CALCOLO GIORNO GARANTITO
   (Tiene conto di cut-off + giorno richiesto)
========================================================== */
function computeGuaranteedDate(area, zona, dtIns, reqDate){
    const giorni=["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];

    // Giorno di inserimento (solo parte data)
    let base = new Date(dtIns.getFullYear(), dtIns.getMonth(), dtIns.getDate());
    const weekday = base.getDay();

    let offset;

    // Gestione weekend + cut-off
    if (weekday === 6 || weekday === 0) {
        // Sabato o domenica → si parte dal lunedì successivo
        base = (weekday === 6) ? addDays(base, 2) : addDays(base, 1);
        offset = 1;
    } else {
        const h = dtIns.getHours(), m = dtIns.getMinutes();
        const entroCutOff = (h < 13) || (h === 13 && m === 0);
        offset = entroCutOff ? 1 : 2;
    }

    // Primo giorno utile teorico (da cut-off)
    const primoDaCutoff = addWorkingDays(base, offset);

    // Non possiamo garantire prima del giorno richiesto
    let d = new Date(Math.max(primoDaCutoff.getTime(), reqDate.getTime()));

    // Cerchiamo il primo giorno in piano >= max(cutoff, richiesto)
    while (true) {
        if (isWorkingDay(d) && isInPiano(area, zona, giorni[d.getDay()])) break;
        d = addWorkingDays(d, 1);
    }

    return d;
}

/* ==========================================================
   FUNZIONE PRINCIPALE (AREE CON CALCOLO)
========================================================== */
function calcola(){
    const area=document.getElementById("area").value;
    if(area==="resto") return; // già gestito da mostraProceduraResto

    const zona=document.getElementById("zona").value;
    const dRich=document.getElementById("giornoRichiesto").value;
    const dIns=document.getElementById("inserimento").value;
    const out=document.getElementById("result");

    if(!area||!dRich||!dIns){ out.innerHTML="⚠️ Compila tutti i campi."; return; }
    if((area==="brescia"||area==="emilia")&&!zona){ out.innerHTML="⚠️ Seleziona sottozona."; return; }

    const dtR=new Date(dRich);
    const dtI=new Date(dIns);
    const giorni=["domenica","lunedi","martedi","mercoledi","giovedi","venerdi","sabato"];
    const giornoRich=giorni[dtR.getDay()];
    const reqDate = new Date(dtR.getFullYear(), dtR.getMonth(), dtR.getDate());

    let zonaEff=zona;
    if(area==="torino") zonaEff="Comuni di Torino";
    if(area==="sardegna") zonaEff="Sud Sardegna";

    const inPianoRichiesto = isInPiano(area,zonaEff,giornoRich);

    // Nuovo calcolo: giorno garantito tenendo conto anche del giorno richiesto
    const dtGarantito = computeGuaranteedDate(area, zonaEff, dtI, reqDate);
    const giornoGarantito = giorni[dtGarantito.getDay()];
    const garDate = new Date(dtGarantito.getFullYear(), dtGarantito.getMonth(), dtGarantito.getDate());

    let supplemento="NO";
    let motivo="Richiesta in piano e compatibile con cut-off.";

    if (reqDate.getTime() !== garDate.getTime()) {
        supplemento = "SI";
        if (reqDate < garDate) {
            motivo = "Richiesta precedente al primo giorno utile (cut-off + piano).";
        } else {
            motivo = "Giorno richiesto fuori piano: consegna possibile con supplemento.";
        }
    }

    out.innerHTML=`
<b>Area:</b> ${area.toUpperCase()}<br>
<b>Zona:</b> ${zonaEff}<br><br>

<b>Giorno richiesto:</b> ${giornoRich.toUpperCase()} (${formatDate(reqDate)})<br>
<b>Giorno garantito (cut-off + piano):</b> ${giornoGarantito.toUpperCase()} (${formatDate(garDate)})<br><br>

<b>Piano consegne (giorno richiesto):</b> ${inPianoRichiesto ? "✔ In piano" : "⛔ Fuori piano"}<br>
<b>Supplemento:</b> ${supplemento} (importo: ${costi[area]})<br>
<b>Motivo:</b> ${motivo}
`;
}
</script>
